# apiVersion: v1
# kind: ConfigMap
# metadata:
#   name: backend-nginx-config
#   namespace: reservation-app
# data:
#   default.conf: |
#     server {
#       listen 80;
#       server_name _;
      
#       # Access logs
#       access_log /var/log/nginx/access.log;
#       error_log /var/log/nginx/error.log;

#       location / {
#         # FastCGI pass to backend service on port 9000
#         fastcgi_pass backend:9000;
#         fastcgi_index index.php;
        
#         # Script filename - critical for Laravel
#         fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
#         fastcgi_param SCRIPT_NAME /index.php;
        
#         # Include fastcgi params
#         include fastcgi_params;
        
#         # Additional params
#         fastcgi_param PATH_INFO $fastcgi_path_info;
#         fastcgi_param QUERY_STRING $query_string;
#         fastcgi_param REQUEST_METHOD $request_method;
#         fastcgi_param CONTENT_TYPE $content_type;
#         fastcgi_param CONTENT_LENGTH $content_length;
        
#         # Timeouts
#         fastcgi_read_timeout 300;
#         fastcgi_send_timeout 300;
#       }
#       location /metrics {
#           try_files /metrics.php =404;
#       }
#       # Health check
#       location /health {
#         access_log off;
#         return 200 "healthy\n";
#         add_header Content-Type text/plain;
#       }
#     }
apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-nginx-config
  namespace: reservation-app
data:
  default.conf: |
    server {
        listen 80;
        server_name _;

        root /var/www/html/public;

        index index.php;

        # ------------------------------------------------------------------------------
        # Laravel main app
        # ------------------------------------------------------------------------------
        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        # ------------------------------------------------------------------------------
        # Prometheus metrics
        # ------------------------------------------------------------------------------
        location /metrics {
            try_files /metrics.php =404;
        }

        # ------------------------------------------------------------------------------
        # PHP Handler (FPM)
        # ------------------------------------------------------------------------------
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass 127.0.0.1:9000;   # php-fpm inside SAME container
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        }

        # ------------------------------------------------------------------------------
        # Health
        # ------------------------------------------------------------------------------
        location /health {
            return 200 "healthy\n";
        }
    }
